<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EbookPro – Premium Ebook Creator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script src="https://unpkg.com/marked@4.0.12/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    :root{--gold:#D4AF37;--deep:#1A1A2E;--cream:#FDF6E3;--ink:#0D0D0D}
    body{font-family:Inter,sans-serif;background:#FDF6E3;color:#0D0D0D;margin:0;padding:0;display:flex;flex-direction:column;align-items:center}
    header{background:var(--deep);color:#fff;width:100%;padding:1rem;text-align:center}
    h1{font-family:'Cormorant Garamond',serif;font-size:2.5rem;margin:0}
    .container{max-width:900px;width:100%;padding:2rem}
    .input-group{margin:1rem 0}
    label{display:block;margin-bottom:.5rem;font-weight:600}
    input,select,textarea{width:100%;padding:.75rem;border:1px solid #ccc;border-radius:8px;font-size:1rem}
    .upload{border:2px dashed var(--deep);border-radius:12px;padding:2rem;text-align:center;cursor:pointer;margin:1rem 0}
    .upload.dragover{background:var(--cream)}
    button{background:var(--deep);color:#fff;padding:.75rem 1.5rem;border:none;border-radius:8px;cursor:pointer;font-weight:600;margin:.5rem 0}
    button:hover{background:var(--gold);color:var(--deep)}
    .preview iframe{width:100%;height:800px;border:1px solid #ddd}
    .hidden{display:none}
    .thumb-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:.5rem}
    .thumb{border:1px solid #ddd;cursor:pointer;border-radius:4px;overflow:hidden}
    .thumb img{width:100%;height:auto}
    .thumb.selected{border:2px solid var(--gold)}
    .roman{font-style:italic}
  </style>
</head>
<body>
<header><h1>EbookPro</h1><p>Premium Creator – $49 Pro Export</p></header>
<div class="container">
  <!-- ==== METADATA ==== -->
  <div class="input-group">
    <label>Title</label><input id="title">
    <label>Subtitle</label><input id="subtitle">
    <label>Author</label><input id="author">
  </div>

  <div class="input-group">
    <label>Category</label>
    <select id="category">
      <option value="">Select</option>
      <option value="business">Business / Entrepreneurship</option>
      <option value="self-help">Self-help / Personal Growth</option>
      <option value="memoir">Memoir / Narrative Nonfiction</option>
      <option value="tech">Tech / How-to</option>
      <option value="cookbooks">Cookbooks / Lifestyle</option>
      <option value="design">Design / Artbooks</option>
      <option value="children">Children’s / Short Reads</option>
    </select>
  </div>

  <!-- ==== TEXT UPLOAD ==== -->
  <div class="input-group">
    <label>Upload Draft (DOCX, MD, TXT, PDF)</label>
    <div id="textDrop" class="upload">Drop file or click</div>
    <input type="file" id="textFile" accept=".docx,.md,.txt,.pdf" class="hidden">
  </div>

  <!-- ==== IMAGES UPLOAD ==== -->
  <div class="input-group">
    <label>Upload Images (JPG, PNG, WEBP, SVG)</label>
    <div id="imgDrop" class="upload">Drop files or click</div>
    <input type="file" id="imgFile" multiple accept="image/*" class="hidden">
    <div id="imgThumbs" class="thumb-grid"></div>
    <label><input type="checkbox" id="coverOnly"> Cover only</label>
    <label><input type="radio" name="place" value="auto" checked> Auto-place</label>
    <label><input type="radio" name="place" value="manual"> Manual</label>
  </div>

  <!-- ==== FRONT/BACK ==== -->
  <div class="input-group">
    <label>Dedication</label><textarea id="dedication" rows="2"></textarea>
    <label>Foreword</label><textarea id="foreword" rows="3"></textarea>
    <label>How to Use</label><textarea id="howto" rows="3"></textarea>
    <label>Copyright</label><input id="copyright" value="© [Year] [Author]">
    <label>ISBN</label><input id="isbn">
    <label>About Author</label><textarea id="about" rows="4"></textarea>
    <label><input type="checkbox" id="roman" checked> Roman numerals (front)</label>
  </div>

  <button id="previewBtn">Preview</button>
  <button id="publishBtn">Publish & Save</button>
  <button id="recreateBtn">Recreate</button>
  <button id="proBtn">Pro Export $49</button>

  <div id="preview" class="preview hidden"></div>
  <div id="marketing" class="hidden"><h2>Marketing Pack (Pro)</h2></div>
</div>

<script>
/* ==== GLOBAL STATE ==== */
let state = {title:'',subtitle:'',author:'',category:'',chapters:[],images:[],front:{},roman:true,pro:false};

/* ==== CATEGORY PALETTES ==== */
const palettes = {
  business:{p:'#D4AF37',s:'#1A1A2E'},
  'self-help':{p:'#2ECC71',s:'#1A1A2E'},
  memoir:{p:'#E74C3C',s:'#1A1A2E'},
  tech:{p:'#3498DB',s:'#1A1A2E'},
  cookbooks:{p:'#E67E22',s:'#1A1A2E'},
  design:{p:'#9B59B6',s:'#1A1A2E'},
  children:{p:'#F1C40F',s:'#1A1A2E'}
};

/* ==== DRAG-DROP ==== */
['textDrop','imgDrop'].forEach(id=>document.getElementById(id).onclick=()=>document.getElementById(id==='textDrop'?'textFile':'imgFile').click());

/* ==== TEXT PARSE ==== */
document.getElementById('textFile').onchange = async e=>{
  const file = e.target.files[0];
  const arr = await file.arrayBuffer();
  let html='';
  if(file.name.endsWith('.docx')){
    const r=await mammoth.convertToHtml({arrayBuffer:arr});
    html=r.value;
  }else if(file.name.endsWith('.md')){
    html=marked.parse(await file.text());
  }else if(file.name.endsWith('.pdf')){
    const pdf=await pdfjsLib.getDocument({data:arr}).promise;
    for(let i=1;i<=pdf.numPages;i++){
      const p=await pdf.getPage(i);
      const t=await p.getTextContent();
      html+=t.items.map(x=>x.str).join(' ')+'\n';
    }
    html=`<p>${html.replace(/\n/g,'</p><p>')}</p>`;
  }else html=await file.text();
  parseChapters(html);
  updatePreview();
};

/* ==== IMAGE THUMBS ==== */
document.getElementById('imgFile').onchange = e=>{
  state.images=[];
  const grid=document.getElementById('imgThumbs');grid.innerHTML='';
  Array.from(e.target.files).forEach(f=>{
    const url=URL.createObjectURL(f);
    state.images.push({url,file:f});
    const d=document.createElement('div');d.className='thumb';
    const img=new Image();img.src=url;img.onclick=()=>d.classList.toggle('selected');
    d.appendChild(img);grid.appendChild(d);
  });
  updatePreview();
};

/* ==== CHAPTER SPLIT ==== */
function parseChapters(raw){
  let html=raw;
  if(!raw.includes('<')) html=marked.parse(raw);
  const doc=new DOMParser().parseFromString(html,'text/html');
  const heads=doc.querySelectorAll('h1,h2,h3');
  const chapters=[];let cur={title:'Intro',content:''};
  const nodes=[...doc.body.childNodes];let i=0;
  heads.forEach(h=>{
    while(i<nodes.length && nodes[i]!==h){cur.content+=nodes[i].outerHTML||nodes[i].textContent;i++;}
    if(cur.content.trim()) chapters.push(cur);
    cur={title:h.textContent.trim(),content:''};i++;
  });
  while(i<nodes.length){cur.content+=nodes[i].outerHTML||nodes[i].textContent;i++;}
  if(cur.content.trim()) chapters.push(cur);
  state.chapters=chapters.length?chapters:[{title:state.title||'Book',content:raw}];
}

/* ==== ROMAN ==== */
function toRoman(n){
  const r={M:1000,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1};
  let s='';for(let k of Object.keys(r)){let q=Math.floor(n/r[k]);n-=q*r[k];s+=k.repeat(q);}return s.toLowerCase();
}

/* ==== HTML GENERATOR ==== */
function generateHTML(){
  const pal=palettes[state.category]||palettes.business;
  let html=`<!DOCTYPE html><html><head><style>
    @page{size:6in 9in;margin:1in;}
    body{font-family:'Cormorant Garamond',serif;line-height:1.7;color:#0D0D0D;}
    h1,h2{color:${pal.p};}
    .page{page-break-after:always;min-height:8in;position:relative;padding:0.5in;}
    .front{counter-increment:none;}
    .pagenum{position:absolute;bottom:0.5in;right:1in;font-size:0.8rem;}
    .roman{font-style:italic;}
  </style></head><body>`;
  let fp=1;
  html+=`<div class="page front"><h1 style="text-align:center;margin-top:3in">${state.title}</h1><p style="text-align:center">${state.subtitle}</p><p style="text-align:center">${state.author}</p></div>`;
  html+=`<div class="page front"><p style="text-align:center">${state.copyright.replace('[Year]',new Date().getFullYear()).replace('[Author]',state.author)}<br>ISBN: ${state.isbn||'—'}</p></div>`;
  if(state.dedication) html+=`<div class="page front"><p style="text-align:center;font-style:italic">${state.dedication}</p>${state.roman?`<div class="pagenum roman">${toRoman(fp++)}</div>`:''}</div>`;
  html+=`<div class="page front"><h2 style="text-align:center">Contents</h2><ol>`;
  state.chapters.forEach((c,i)=>html+=`<li><a href="#ch${i}">${c.title}</a></li>`);
  html+=`</ol>${state.roman?`<div class="pagenum roman">${toRoman(fp++)}</div>`:''}</div>`;
  if(state.foreword) html+=`<div class="page front"><h2>Foreword</h2><p>${state.foreword.replace(/\n/g,'</p><p>')}</p>${state.roman?`<div class="pagenum roman">${toRoman(fp++)}</div>`:''}</div>`;
  if(state.howto) html+=`<div class="page front"><h2>How to Use This Book</h2><p>${state.howto.replace(/\n/g,'</p><p>')}</p>${state.roman?`<div class="pagenum roman">${toRoman(fp++)}</div>`:''}</div>`;

  let p=1;
  state.chapters.forEach((c,i)=>{
    let content=c.content;
    if(!document.getElementById('coverOnly').checked && document.querySelector('input[name="place"]:checked').value==='auto' && state.images[i%state.images.length]){
      content=`<img src="${state.images[i%state.images.length].url}" style="max-width:100%;height:auto;display:block;margin:1rem auto;">`+content;
    }
    html+=`<div class="page" id="ch${i}"><h2>${c.title}</h2>${content}<div class="pagenum">${p++}</div></div>`;
  });
  if(state.about) html+=`<div class="page"><h2>About the Author</h2><p>${state.about}</p><div class="pagenum">${p++}</div></div>`;
  html+=`</body></html>`;
  return html;
}

/* ==== PREVIEW ==== */
function updatePreview(){
  // sync UI → state
  ['title','subtitle','author','category','dedication','foreword','howto','copyright','isbn','about'].forEach(id=>state[id]=document.getElementById(id).value);
  state.roman=document.getElementById('roman').checked;
  const html=generateHTML();
  const prev=document.getElementById('preview');
  prev.innerHTML=`<iframe srcdoc="${html.replace(/"/g,'&quot;')}"></iframe>`;
  prev.classList.remove('hidden');
}
document.getElementById('previewBtn').onclick=updatePreview;

/* ==== PUBLISH (save template) ==== */
document.getElementById('publishBtn').onclick=()=>{
  localStorage.setItem('tpl_'+Date.now(),JSON.stringify(state));
  saveAs(new Blob([generateHTML()],{type:'text/html'}),`${state.title||'ebook'}.html`);
  document.getElementById('marketing').classList.remove('hidden');
};

/* ==== RECREATE ==== */
document.getElementById('recreateBtn').onclick=()=>{
  const pal=palettes[state.category]||palettes.business;
  document.documentElement.style.setProperty('--gold',pal.p);
  updatePreview();
};

/* ==== STRIPE PRO ==== */
const stripe = Stripe('pk_live_XXXXXXXXXXXXXXXXXXXXXXXX'); // ← replace
document.getElementById('proBtn').onclick=async()=>{
  const resp=await fetch(`${API_URL}/create-checkout`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({priceId:'price_1XXXXXX',ebook:state})
  });
  const {id}=await resp.json();
  stripe.redirectToCheckout({sessionId:id});
};

/* ==== PWA SW ==== */
if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
  </html>
